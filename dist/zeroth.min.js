(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Zeroth={})})(this,(function(e){"use strict";var r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=window,a=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,s=t.URL||t.webkitURL||t.mozURL||t.msURL,i="application/javascript",c="undefined"==typeof Symbol?"__t"+ +new Date:Symbol(),u=t.Worker,f=t.setImmediate||function(e){return setTimeout(e,1)};function l(o,n){var r=Object.create(null);return o.onmessage=null,o.addEventListener=function(e,t){var n=r[e]||(r[e]=[]);~n.indexOf(t)||n.push(t)},o.removeEventListener=function(e,t){var n,o=r[e];o&&-1!==(n=o.indexOf(t))&&(o.splice(n,1),o.length||delete r[e])},o.postMessage=function(t){f((function(){var e=t;if(n.onmessage)try{n.onmessage({data:e,target:o})}catch(e){console.error(e)}n.emit("message",{type:"message",data:e,target:o,timeStamp:+new Date})}))},o.emit=function(e,n){var t=r[e];t&&t.forEach((function(e,t){return e.call(o,n)}))},o.destroy=function(){Object.keys(r).forEach((function(e){var t=r[e];t&&(t.length=0,delete r[e])})),r=null},o}if(u){var n,o=p("self.onmessage = function () {}"),d=new Uint8Array(1);try{if(/(?:Trident|Edge)\/(?:[567]|12)/i.test(navigator.userAgent))throw new Error("Not available");(n=new u(o)).postMessage(d,[d.buffer])}catch(e){u=null}finally{s.revokeObjectURL(o),n&&n.terminate()}}function p(t){var n=i;try{return s.createObjectURL(new Blob([t],{type:n}))}catch(e){var o=new a;return o.append(t),s.createObjectURL(o.getBlob(n))}}var m,h,g=(m="worker#./base.worker.js",h=function(){return (function(e,t){var n=null,h=function(){},g={wsServerAddr:"13.125.232.133",wsServerPort:3180,wssServerAddr:"zeroth-test.goodatlas.com",wssServerPort:2087,sampleRate:44100,defaultParams:{language:"eng",finalOnly:!1,ws:!1}};e.exports=function(e){e.onmessage=function(e){switch(e.data.command){case"init":n=new o(e.data.params);break;case"disconnect":n.disconnect();break;case"send":n.send(e.data.data)}}};var o=function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s.call(this),t&&t.key){t.debug&&(h=function(){for(var e,t=arguments.length,n=Array(t),o=0;o<t;o++)n[o]=arguments[o];return(e=console).log.apply(e,["[zerothjs:debug]"].concat(n))});var n=g.defaultParams,o=n.language,r=n.finalOnly,a=n.ws;this.params={key:t.key,language:t.language||o,finalOnly:t.finalOnly||r,ws:t.ws||a},this.ws=null,this.connect()}else postMessage({command:"onerror",error:"API key missing"})},s=function(){var m=this;this.connect=function(){var e=g,t=e.wsServerAddr,n=e.wsServerPort,o=e.wssServerAddr,r=e.wssServerPort,a=e.sampleRate,s=m.params,i=s.key,c=s.language,u=s.finalOnly,f=s.ws,l="audio/x-raw,+layout=(string)interleaved,+rate=(int)"+a+",+format=(string)S16LE,+channels=(int)1",d="content-type="+l+"&key="+i+"&language="+c+"&final-only="+u,p=f?"ws://"+t+":"+n+"/client/ws/speech?"+d:"wss://"+o+":"+r+"/client/ws/speech?"+d;h("uri",p),m.ws=new WebSocket(p),m.ws.onopen=function(){postMessage({command:"onconnect"})},m.ws.onerror=function(e){h("websocket error",e.code,e.reason,e.message),postMessage({command:"onerror",error:e.message})},m.ws.onclose=function(e){h("websocket closed",e.code,e.reason,e.message),m.ws=null,postMessage({command:"ondisconnect"})},m.ws.onmessage=function(e){postMessage({command:"ondata",data:JSON.parse(e.data)})}},this.send=function(e){if(m.ws)try{m.ws.send(e)}catch(e){h("websocket send data error",e.code,e.reason,e.message),postMessage({command:"onerror",error:e.message}),m.ws.close()}},this.disconnect=function(){m.send("EOS")}}})(e={exports:{}}),e.exports;var e},function e(t){var n=this;if(!(n instanceof e))return new e(t);if(!h)return new u(m);if(u&&!t){var o=p(';(function(f){f&&new(f.default?f["default"]:f)(self)}(('+h.toString()+")()))"),r=new u(o);return s.revokeObjectURL(o),n[c]=r}var a=new l({close:function(){this.destroy()}},n);Object.assign(new l(n,a),{isThisThread:!0,terminate:function(){a.close(),this.destroy()}}),h().call(a,a)}),w=null,y=function e(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.throwIfParamsMissing();r(this,e),this.init=function(){(w=new g).postMessage({command:"init",params:t.params,sampleRate:sampleRate}),w.onmessage=function(e){switch(e.data.command){case"onerror":t.onerror(e.data.error);break;case"onconnect":t.onconnect(),t.onready();break;case"ondisconnect":t.ondisconnect(),w.terminate();break;case"ondata":t.ondata(e.data.data)}}},this.send=function(e){w.postMessage({command:"send",data:e})},this.disconnect=function(){w.postMessage({command:"disconnect"})};var o=function(){};this.onconnect=this.onconnect||o,this.onready=this.onready||o,this.ondisconnect=this.ondisconnect||o,this.ondata=this.ondata||o,this.onerror=this.onerror||o,this.params=n};function v(e,t){return e(t={exports:{}},t.exports),t.exports}var b=v((function(t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?t.exports=o=function(e){return n(e)}:t.exports=o=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)},o(e)}t.exports=o}));var S=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var x=function(e,t){return!t||"object"!==b(t)&&"function"!=typeof t?S(e):t},O=v((function(t){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}t.exports=n})),k=v((function(n){function o(e,t){return n.exports=o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}n.exports=o}));var M=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&k(e,t)},j=window.AudioContext||window.webkitAudioContext,A=function(e){for(var t=e.length,n=new Int16Array(t);t--;)n[t]=32767*Math.min(1,e[t]);return n},P=44100,E=function(){},R=(function(e){function t(e){var s;return r(this,t),(s=x(this,O(t).call(this,e))).start=function(){return new Promise(function(t,n){var e=function(e){E("Successfully got UserMedia"),s.stream=e,s.recording(),t()},o=function(e){return n(e)},r={audio:!0,video:!1};if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)navigator.mediaDevices.getUserMedia(r).then(e,o);else{var a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(!a)return E("Couldn't found getUserMedia on your browser."),void n(new Error("Your browser dosen't support Media"));a(r).then(e,o)}})},s.recording=function(){s.context=new j,s.init(s.context.sampleRate),s.onready=function(){var e=S(S(s)),t=e.bufferSize,n=e.channels,o=e.stream,r=s.context.createMediaStreamSource(o),a=s.context.createScriptProcessor(t,n,n);r.connect(a),a.connect(s.context.destination),a.onaudioprocess=s.onAudioProcess}},s.onAudioProcess=function(e){var t=e.inputBuffer.getChannelData(0),n=A(t);s.send(n)},s.stop=function(){s.context&&"closed"!==s.context.state&&s.context.close(),s.stream.getTracks().forEach((function(e){e.stop()})),s.disconnect()},s.params=e,s.stream=null,s.bufferSize=2048,s.channels=1,s.sampleRate=P,e.debug&&(E=function(){for(var e,t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];return(e=console).log.apply(e,["[zerothjs:debug]"].concat(n))}),s.params=e,s}return M(t,y),t})(),U=(function(e){function t(e){var n;if(r(this,t),(n=x(this,O(t).call(this,e))).sendFile=function(){var e=n.file,t=new FileReader;t.onload=function(e){var t=new j,n=e.target.result;t.decodeAudioData(n,(function(e){var t=e.getChannelData(0),n=A(t);zeroth.send(n),zeroth.disconnect()}))},t.readAsArrayBuffer(e)},n.onready=function(){n.sendFile(n.file)},n.init(e),n.file=e.file,void 0===n.file)throw Error("Parameter `file` is required.");if(!/^audio/.test(n.file.type))throw Error("Expected Audio file but got ".concat(n.file.type," file."));return n.sampleRate=P,n}return M(t,y),t})();e.ZerothBase=y,e.ZerothMic=R,e.ZerothFile=U,Object.defineProperty(e,"__esModule",{value:!0})}));
