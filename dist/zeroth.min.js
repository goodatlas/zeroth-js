(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Zeroth={})})(this,(function(e){"use strict";var r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=window,a=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder,s=t.URL||t.webkitURL||t.mozURL||t.msURL,i="application/javascript",c="undefined"==typeof Symbol?"__t"+ +new Date:Symbol(),u=t.Worker,f=t.setImmediate||function(e){return setTimeout(e,1)};function d(o,n){var r=Object.create(null);return o.onmessage=null,o.addEventListener=function(e,t){var n=r[e]||(r[e]=[]);~n.indexOf(t)||n.push(t)},o.removeEventListener=function(e,t){var n,o=r[e];o&&-1!==(n=o.indexOf(t))&&(o.splice(n,1),o.length||delete r[e])},o.postMessage=function(t){f((function(){var e=t;if(n.onmessage)try{n.onmessage({data:e,target:o})}catch(e){console.error(e)}n.emit("message",{type:"message",data:e,target:o,timeStamp:+new Date})}))},o.emit=function(e,n){var t=r[e];t&&t.forEach((function(e,t){return e.call(o,n)}))},o.destroy=function(){Object.keys(r).forEach((function(e){var t=r[e];t&&(t.length=0,delete r[e])})),r=null},o}if(u){var n,o=p("self.onmessage = function () {}"),l=new Uint8Array(1);try{if(/(?:Trident|Edge)\/(?:[567]|12)/i.test(navigator.userAgent))throw new Error("Not available");(n=new u(o)).postMessage(l,[l.buffer])}catch(e){u=null}finally{s.revokeObjectURL(o),n&&n.terminate()}}function p(t){var n=i;try{return s.createObjectURL(new Blob([t],{type:n}))}catch(e){var o=new a;return o.append(t),s.createObjectURL(o.getBlob(n))}}var m,h,g=(m="worker#./base.worker.js",h=function(){return (function(e,t){var n=null,m=function(){},h={wsServerAddr:"13.125.232.133",wsServerPort:3180,wssServerAddr:"zeroth-test.goodatlas.com",wssServerPort:2087,apiServerPort:2053,sampleRate:44100,defaultParams:{language:"eng",finalOnly:!1,ws:!1}};e.exports=function(e){e.onmessage=function(e){switch(e.data.command){case"init":n=new o(e.data.params);break;case"disconnect":n.disconnect();break;case"send":n.send(e.data.data)}}};var o=function e(t,n){var o=this;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),d.call(this),t){if(!t.accessToken){if(m("You don't have accessToken. Will use fallback way"),!t.appSecret)return void postMessage({command:"onerror",error:"Tried to issue access token, but appSecret is missing"});if(!t.appId)return void postMessage({command:"onerror",error:"Tried to issue access token, but appId is missing"})}if(t.accessToken&&t.appId)postMessage({command:"onerror",error:"You don't have to use appId if you already have accessToken"});else if(t.accessToken&&t.appSecret)postMessage({command:"onerror",error:"You don't have to use appSecret if you already have accessToken"});else{t.debug&&(m=function(){for(var e,t=arguments.length,n=Array(t),o=0;o<t;o++)n[o]=arguments[o];return(e=console).log.apply(e,["[zerothjs:debug]"].concat(n))});var r=h.defaultParams,a=r.language,s=r.finalOnly,i=r.ws;if(this.params={language:t.language||a,finalOnly:t.finalOnly||s,ws:t.ws||i},this.ws=null,this.sampleRate=n||h.sampleRate,this.params.accessToken)this.params.accessToken=t.accessToken,this.connect();else{var c=h,u=c.wssServerAddr,f=c.apiServerPort;fetch("https://"+u+":"+f+"/token",{headers:{Authorization:t.appId+":"+t.appSecret,"Access-Control-Allow-Origin":"*","Proxy-Authorization":t.appId+":"+t.appSecret},withCredential:!0}).then((function(e){return e.json()})).then((function(e){o.params.accessToken=e.access_token,o.connect()})).catch((function(e){postMessage({command:"onerror",error:JSON.stringify(e)})}))}}}else postMessage({command:"onerror",error:"Parameter missing"})},d=function(){var p=this;this.connect=function(){var e=h,t=e.wsServerAddr,n=e.wsServerPort,o=e.wssServerAddr,r=e.wssServerPort,a=p.params,s=a.accessToken,i=a.language,c=a.finalOnly,u=a.ws,f="audio/x-raw,+layout=(string)interleaved,+rate=(int)"+p.sampleRate+",+format=(string)S16LE,+channels=(int)1",d="access-token="+s+"&content-type="+f+"&language="+i+"&final-only="+c,l=u?"ws://"+t+":"+n+"/client/ws/speech?"+d:"wss://"+o+":"+r+"/client/ws/speech?"+d;m("uri",l),p.ws=new WebSocket(l),p.ws.onopen=function(){postMessage({command:"onconnect"}),m("connected to zeroth",l)},p.ws.onerror=function(e){m("websocket error",e.code,e.reason,e.message),postMessage({command:"onerror",error:e.message})},p.ws.onclose=function(e){m("websocket closed",e.code,e.reason,e.message),p.ws=null,postMessage({command:"ondisconnect"})},p.ws.onmessage=function(e){postMessage({command:"ondata",data:JSON.parse(e.data)})}},this.send=function(e){if(p.ws)try{p.ws.send(e)}catch(e){m("websocket send data error",e.code,e.reason,e.message),postMessage({command:"onerror",error:e.message}),p.ws.close()}},this.disconnect=function(){p.send("EOS")}}})(e={exports:{}}),e.exports;var e},function e(t){var n=this;if(!(n instanceof e))return new e(t);if(!h)return new u(m);if(u&&!t){var o=p(';(function(f){f&&new(f.default?f["default"]:f)(self)}(('+h.toString()+")()))"),r=new u(o);return s.revokeObjectURL(o),n[c]=r}var a=new d({close:function(){this.destroy()}},n);Object.assign(new d(n,a),{isThisThread:!0,terminate:function(){a.close(),this.destroy()}}),h().call(a,a)}),w=null,v=function e(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.throwIfParamsMissing();r(this,e),this.init=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:44100;(w=new g).postMessage({command:"init",params:t.params,sampleRate:e}),w.onmessage=function(e){switch(e.data.command){case"onerror":t.onerror(e.data.error);break;case"onconnect":t.onconnect(),t.onready();break;case"ondisconnect":t.ondisconnect(),w.terminate();break;case"ondata":t.ondata(e.data.data)}}},this.send=function(e){w.postMessage({command:"send",data:e})},this.disconnect=function(){w.postMessage({command:"disconnect"})};var o=function(){};this.onconnect=this.onconnect||o,this.onready=this.onready||o,this.ondisconnect=this.ondisconnect||o,this.ondata=this.ondata||o,this.onerror=this.onerror||o,this.params=n};function y(e,t){return e(t={exports:{}},t.exports),t.exports}var b=y((function(t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?t.exports=o=function(e){return n(e)}:t.exports=o=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)},o(e)}t.exports=o}));var S=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var k=function(e,t){return!t||"object"!==b(t)&&"function"!=typeof t?S(e):t},x=y((function(t){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}t.exports=n})),M=y((function(n){function o(e,t){return n.exports=o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}n.exports=o}));var O=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&M(e,t)},A=window.AudioContext||window.webkitAudioContext,P=function(e){for(var t=e.length,n=new Int16Array(t);t--;)n[t]=32767*Math.min(1,e[t]);return n},T=44100,j=function(){},R=(function(e){function t(e){var s;return r(this,t),(s=k(this,x(t).call(this,e))).start=function(){return new Promise(function(t,n){var e=function(e){j("Successfully got UserMedia"),s.stream=e,s.recording(),t()},o=function(e){return n(e)},r={audio:!0,video:!1};if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)navigator.mediaDevices.getUserMedia(r).then(e,o);else{var a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(!a)return j("Couldn't found getUserMedia on your browser."),void n(new Error("Your browser dosen't support Media"));a(r).then(e,o)}})},s.recording=function(){s.context=new A,s.init(s.context.sampleRate),s.onready=function(){var e=S(S(s)),t=e.bufferSize,n=e.channels,o=e.stream,r=s.context.createMediaStreamSource(o),a=s.context.createScriptProcessor(t,n,n);r.connect(a),a.connect(s.context.destination),a.onaudioprocess=s.onAudioProcess}},s.onAudioProcess=function(e){var t=e.inputBuffer.getChannelData(0),n=P(t);s.send(n)},s.stop=function(){s.context&&"closed"!==s.context.state&&s.context.close(),s.stream.getTracks().forEach((function(e){e.stop()})),s.disconnect()},s.params=e,s.stream=null,s.bufferSize=2048,s.channels=1,s.sampleRate=T,e.debug&&(j=function(){for(var e,t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];return(e=console).log.apply(e,["[zerothjs:debug]"].concat(n))}),s.params=e,s}return O(t,v),t})(),E=(function(e){function t(e){var o;if(r(this,t),(o=k(this,x(t).call(this,e))).sendFile=function(){var e=o.file,t=new FileReader;t.onload=function(e){var t=e.target.result;o.audioCtx.decodeAudioData(t,(function(e){var t=e.getChannelData(0),n=P(t);o.send(n),o.disconnect()}))},t.readAsArrayBuffer(e)},o.onready=function(){o.sendFile(o.file)},o.file=e.file,void 0===o.file)throw Error("Parameter `file` is required.");if(!/^audio/.test(o.file.type))throw Error("Expected Audio file but got ".concat(o.file.type," file."));return o.sampleRate=T,o.audioCtx=new A,o.init(o.audioCtx.sampleRate),o}return O(t,v),t})();e.ZerothBase=v,e.ZerothMic=R,e.ZerothFile=E,Object.defineProperty(e,"__esModule",{value:!0})}));
